# FluxLib 泛集库业务流程文档

## 一、整体架构概述

FluxLib 泛集库采用**前后端分离架构**，基于「前端交互层 - 后端服务层 - 数据存储层」三层架构设计，各层职责与技术栈明确，链路流转清晰。

### 1.1 架构分层与核心组件

| 层级       | 技术栈                                        | 核心职责                             | 关键组件示例                                                 |
| ---------- | --------------------------------------------- | ------------------------------------ | ------------------------------------------------------------ |
| 前端交互层 | Vue 3 + Element Plus + Pinia                  | 用户交互、状态管理、请求封装         | 视图（LoginView/BooksView）、Store（user.js/book.js）、API 封装（api.js） |
| 后端服务层 | Flask + 分层架构（路由 - 服务 - 模型 - 仓储） | 接收请求、业务逻辑处理、数据访问调度 | 路由（auth_routes.py）、服务（auth_service.py）、模型（user.py）、仓储（user_repository.py） |
| 数据存储层 | 阿里云 OTS（表格存储）+ Redis + OSS           | 结构化数据存储、缓存、文件存储       | OTS 表（USERS_TABLE/Books）、Redis（Token 缓存）、OSS（图书封面） |

### 1.2 核心业务模块清单

系统围绕「图书管理」核心，衍生出 6 大业务模块，各模块独立且联动：

1. 用户认证模块（登录 / 注册 / 密码重置）
2. 图书管理模块（图书 CRUD / 库存管理）
3. 借阅预约模块（借阅 / 归还 / 预约）
4. 互动模块（评论 / 点赞 / 收藏 / 浏览历史）
5. AI 助手模块（智能问答 / 图书推荐）
6. 系统管理模块（管理员仪表盘 / 数据分析）

## 二、核心业务模块详细流程

### 2.1 用户认证模块

#### 2.1.1 模块定位与数据存储

- **核心功能**：用户身份校验、权限控制（普通用户 / 管理员）、账号安全（验证码 / 密码重置）

- 涉及系统：

  - 前端：`LoginView.vue`（登录 / 注册）、`ForgotPassword.vue`（密码重置）、`user.js`（状态管理）、`api.js`（认证请求封装）
  - 后端：`user.py`（用户模型）、`user_repository.py`（用户数据仓储）、`auth_service.py`（认证业务逻辑）、`auth_routes.py`（认证路由）
  
- 数据存储：

  - `USERS_TABLE`（OTS）：存储用户核心信息（user_id/email/password/role/avatar_url 等）
  - `VERIFICATION_CODES_TABLE`（OTS）：存储验证码（email/code/type/expire_time）
  - Redis：缓存 Token（token→user_id 映射）、用户信息（减少 OTS 查询）

#### 2.1.2 上下游链路

- **上游**：用户输入（邮箱 / 密码 / 验证码）
- **下游**：所有需要身份校验的模块（图书借阅、收藏、评论等，均需通过 Token 获取用户 ID）

#### 2.1.3 正向流程（以「登录」为例）

![image]([FluxLib1/picture/业务流程/登陆.png at main · Janhone888/FluxLib1](https://github.com/Janhone888/FluxLib1/blob/main/picture/业务流程/登陆.png))



#### 2.1.4 逆向流程（以「密码重置失败」为例）





#### 2.1.5 关键状态与结果集

| 业务场景 | 核心状态                           | 成功结果集（示例）                                  | 失败结果集（示例）         |
| -------- | ---------------------------------- | --------------------------------------------------- | -------------------------- |
| 登录     | 未登录→已登录（普通用户 / 管理员） | `{"token":"xxx","user_id":"uuid","is_admin":false}` | `{"error":"密码错误"}`     |
| 注册     | 未注册→已注册（待验证→已验证）     | `{"user_id":"uuid","message":"注册成功"}`           | `{"error":"邮箱已注册"}`   |
| 密码重置 | 密码过期→密码更新                  | `{"message":"密码重置成功"}`                        | `{"error":"验证码已过期"}` |

### 2.2 图书管理模块

#### 2.2.1 模块定位与数据存储

- **核心功能**：图书信息管理（新增 / 编辑 / 删除 / 查询）、库存状态维护（借阅减库存 / 归还加库存）
- 涉及系统：
  - 前端：`BooksView`（图书列表）、`AddBook/EditBook`（图书 CRUD）、`BookDetail`（图书详情）、`book.js`（图书状态管理）
  - 后端：`book.py`（图书模型）、`book_repository.py`（图书仓储）、`book_service.py`（图书业务）、`book_routes.py`（图书路由）
- 数据存储：
  - `OTS_TABLE_NAME`（默认`Books`，OTS 表）：存储图书核心信息（book_id/title/author/stock/status 等）
  - OSS：存储图书封面图片（通过预签名 URL 上传）

#### 2.2.2 上下游链路

- **上游**：
  - 管理员操作（新增 / 编辑 / 删除图书）
  - 用户行为（浏览图书→触发浏览历史记录，借阅→触发库存更新）
- **下游**：借阅模块（库存不足时无法借阅）、互动模块（图书详情页关联评论 / 收藏）

#### 2.2.3 正向流程（以「管理员新增图书」为例）







#### 2.2.4 逆向流程（以「图书删除」为例）





#### 2.2.5 关键状态与结果集

| 业务场景 | 核心状态                      | 成功结果集（示例）                            | 失败结果集（示例）              |
| -------- | ----------------------------- | --------------------------------------------- | ------------------------------- |
| 新增图书 | 无→已存在（status=available） | `{"book_id":"uuid","message":"图书创建成功"}` | `{"error":"缺少书名（title）"}` |
| 图书查询 | -                             | `{"items":[...],"total":128,"page":1}`        | `{"error":"图书不存在"}`        |
| 库存更新 | 库存 N→N±1（status 同步更新） | `{"success":true,"message":"库存更新成功"}`   | `{"error":"库存不足"}`          |

### 2.3 借阅预约模块

#### 2.3.1 模块定位与数据存储

- **核心功能**：图书借阅、按期 / 提前归还、图书预约（库存不足时）
- 涉及系统：
  - 前端：`BorrowManage.vue`（借阅管理）、`BookDetail.vue`（借阅 / 归还按钮）、`book.js`（库存状态同步）
  - 后端：`borrow.py`（借阅模型）、`borrow_repository.py`（借阅仓储）、`borrow_service.py`（借阅业务）、`borrow_routes.py`（借阅路由）
- 数据存储：
  - `BORROW_RECORDS_TABLE`（OTS）：存储借阅记录（borrow_id/book_id/user_id/borrow_date/due_date/status）
  - `RESERVATIONS_TABLE`（OTS）：存储预约记录（reservation_id/book_id/reserve_date/time_slot）

#### 2.3.2 上下游链路

- **上游**：用户操作（图书详情页点击「借阅」/「预约」）、图书模块（库存状态校验）
- **下游**：图书模块（借阅减库存 / 归还加库存）、用户模块（借阅记录关联用户）

#### 2.3.3 核心正向流程（「借阅→归还」全链路）





#### 2.3.4 关键状态流转

借阅记录与图书库存存在强关联，状态同步流转：

1. **借阅状态流转**：`未借阅` → 发起借阅 → `借阅中（borrowed）` → 发起归还 → `已归还（returned）`
2. **图书库存流转**：`available（stock=N）` → 借阅 → `available（stock=N-1）`/`borrowed（stock=0）` → 归还 → `available（stock=N）`
3. **预约状态流转**：`无预约` → 发起预约 → `已预约（reserved）` → 预约完成 → `已完成（fulfilled）`/`已取消（cancelled）`

### 2.4 互动模块（评论 / 点赞 / 收藏 / 浏览历史）

#### 2.4.1 模块定位与数据存储

- **核心功能**：用户与图书的互动操作，提升用户粘性
- **涉及系统**：
  - 前端：`BookDetail`（评论区 / 收藏按钮）、`Favorites.vue`（收藏列表）、`History.vue`（浏览历史）
  - 后端：`comment.py`/`favorite.py`/`view_history.py`（模型）、对应服务 / 仓储 / 路由
- 数据存储：
  - `COMMENTS_TABLE`（OTS）：评论主表（comment_id/book_id/content/likes）
  - `COMMENT_LIKES_TABLE`（OTS）：评论点赞表（复合主键：comment_id+user_id）
  - `FAVORITES_TABLE`（OTS）：收藏表（favorite_id/user_id/book_id）
  - `VIEW_HISTORY_TABLE`（OTS）：浏览历史表（history_id/user_id/book_id/view_time）

#### 2.4.2 核心流程（以「评论点赞」为例）







## 三、业务总链路与关键依赖

### 3.1 核心业务总链路（用户视角）







<svg aria-roledescription="flowchart-v2" role="graphics-document document" style="overflow: hidden; max-width: 617.7500610351562px;" class="flowchart" xmlns="http://www.w3.org/2000/svg" width="100%" id="svg-mermaid-diagram-4cgtsyu" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:ev="http://www.w3.org/2001/xml-events"><g id="viewport-20251023190331311" class="svg-pan-zoom_viewport" transform="matrix(0.3820861678004535,0,0,0.3820861678004535,277.9831232602904,0)" style="transform: matrix(0.382086, 0, 0, 0.382086, 277.983, 0);"><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="svg-mermaid-diagram-4cgtsyu_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="svg-mermaid-diagram-4cgtsyu_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="svg-mermaid-diagram-4cgtsyu_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="svg-mermaid-diagram-4cgtsyu_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="svg-mermaid-diagram-4cgtsyu_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="svg-mermaid-diagram-4cgtsyu_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"><path marker-end="url(#svg-mermaid-diagram-4cgtsyu_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_B_0" d="M331.448,56L331.448,60.167C331.448,64.333,331.448,72.667,331.448,80.333C331.448,88,331.448,95,331.448,98.5L331.448,102"></path><path marker-end="url(#svg-mermaid-diagram-4cgtsyu_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B_C_1" d="M331.448,154L331.448,158.167C331.448,162.333,331.448,170.667,331.518,178.417C331.588,186.167,331.729,193.334,331.799,196.917L331.869,200.501"></path><path marker-end="url(#svg-mermaid-diagram-4cgtsyu_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C_D_2" d="M331.948,300.5L331.865,306.083C331.781,311.667,331.615,322.833,331.531,333.417C331.448,344,331.448,354,331.448,359L331.448,364"></path><path marker-end="url(#svg-mermaid-diagram-4cgtsyu_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_D_E_3" d="M331.448,416L331.448,420.167C331.448,424.333,331.448,432.667,331.518,440.417C331.588,448.167,331.729,455.334,331.799,458.917L331.869,462.501"></path><path marker-end="url(#svg-mermaid-diagram-4cgtsyu_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_E_F_4" d="M296.437,526.989L263.414,538.491C230.39,549.993,164.344,572.996,131.32,589.498C98.297,606,98.297,616,98.297,621L98.297,626"></path><path marker-end="url(#svg-mermaid-diagram-4cgtsyu_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_E_G_5" d="M331.948,562.5L331.865,568.083C331.781,573.667,331.615,584.833,331.531,595.417C331.448,606,331.448,616,331.448,621L331.448,626"></path><path marker-end="url(#svg-mermaid-diagram-4cgtsyu_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_E_H_6" d="M365.848,528.6L392.973,539.833C420.098,551.067,474.349,573.533,501.474,589.767C528.599,606,528.599,616,528.599,621L528.599,626"></path><path marker-end="url(#svg-mermaid-diagram-4cgtsyu_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_F_I_7" d="M98.297,678L98.297,682.167C98.297,686.333,98.297,694.667,98.297,702.333C98.297,710,98.297,717,98.297,720.5L98.297,724"></path><path marker-end="url(#svg-mermaid-diagram-4cgtsyu_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I_J_8" d="M98.297,776L98.297,780.167C98.297,784.333,98.297,792.667,98.297,800.333C98.297,808,98.297,815,98.297,818.5L98.297,822"></path><path marker-end="url(#svg-mermaid-diagram-4cgtsyu_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_G_K_9" d="M331.448,678L331.448,682.167C331.448,686.333,331.448,694.667,331.448,702.333C331.448,710,331.448,717,331.448,720.5L331.448,724"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div class="labelBkg" xmlns="http://www.w3.org/1999/xhtml" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; background-color: rgba(245, 235, 255, 0.5); display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; fill: rgba(0, 0, 0, 0.8); color: rgba(0, 0, 0, 0.8); background-color: rgb(245, 235, 255); text-align: center;"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div class="labelBkg" xmlns="http://www.w3.org/1999/xhtml" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; background-color: rgba(245, 235, 255, 0.5); display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; fill: rgba(0, 0, 0, 0.8); color: rgba(0, 0, 0, 0.8); background-color: rgb(245, 235, 255); text-align: center;"></span></div></foreignObject></g></g><g transform="translate(331.44791412353516, 334)" class="edgeLabel"><g transform="translate(-24, -9)" class="label"><foreignObject height="18" width="48"><div class="labelBkg" xmlns="http://www.w3.org/1999/xhtml" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; background-color: rgba(245, 235, 255, 0.5); display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; fill: rgba(0, 0, 0, 0.8); color: rgba(0, 0, 0, 0.8); background-color: rgb(245, 235, 255); text-align: center;"><p style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; color: rgb(0, 0, 0); font-size: 12px; font-weight: 400; line-height: 18px; background-color: rgb(245, 235, 255);">查看详情</p></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div class="labelBkg" xmlns="http://www.w3.org/1999/xhtml" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; background-color: rgba(245, 235, 255, 0.5); display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; fill: rgba(0, 0, 0, 0.8); color: rgba(0, 0, 0, 0.8); background-color: rgb(245, 235, 255); text-align: center;"></span></div></foreignObject></g></g><g transform="translate(98.296875, 596)" class="edgeLabel"><g transform="translate(-12, -9)" class="label"><foreignObject height="18" width="24"><div class="labelBkg" xmlns="http://www.w3.org/1999/xhtml" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; background-color: rgba(245, 235, 255, 0.5); display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; fill: rgba(0, 0, 0, 0.8); color: rgba(0, 0, 0, 0.8); background-color: rgb(245, 235, 255); text-align: center;"><p style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; color: rgb(0, 0, 0); font-size: 12px; font-weight: 400; line-height: 18px; background-color: rgb(245, 235, 255);">借阅</p></span></div></foreignObject></g></g><g transform="translate(331.44791412353516, 596)" class="edgeLabel"><g transform="translate(-12, -9)" class="label"><foreignObject height="18" width="24"><div class="labelBkg" xmlns="http://www.w3.org/1999/xhtml" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; background-color: rgba(245, 235, 255, 0.5); display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; fill: rgba(0, 0, 0, 0.8); color: rgba(0, 0, 0, 0.8); background-color: rgb(245, 235, 255); text-align: center;"><p style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; color: rgb(0, 0, 0); font-size: 12px; font-weight: 400; line-height: 18px; background-color: rgb(245, 235, 255);">收藏</p></span></div></foreignObject></g></g><g transform="translate(528.5989532470703, 596)" class="edgeLabel"><g transform="translate(-12, -9)" class="label"><foreignObject height="18" width="24"><div class="labelBkg" xmlns="http://www.w3.org/1999/xhtml" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; background-color: rgba(245, 235, 255, 0.5); display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; fill: rgba(0, 0, 0, 0.8); color: rgba(0, 0, 0, 0.8); background-color: rgb(245, 235, 255); text-align: center;"><p style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; color: rgb(0, 0, 0); font-size: 12px; font-weight: 400; line-height: 18px; background-color: rgb(245, 235, 255);">评论</p></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div class="labelBkg" xmlns="http://www.w3.org/1999/xhtml" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; background-color: rgba(245, 235, 255, 0.5); display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; fill: rgba(0, 0, 0, 0.8); color: rgba(0, 0, 0, 0.8); background-color: rgb(245, 235, 255); text-align: center;"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div class="labelBkg" xmlns="http://www.w3.org/1999/xhtml" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; background-color: rgba(245, 235, 255, 0.5); display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; fill: rgba(0, 0, 0, 0.8); color: rgba(0, 0, 0, 0.8); background-color: rgb(245, 235, 255); text-align: center;"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div class="labelBkg" xmlns="http://www.w3.org/1999/xhtml" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; background-color: rgba(245, 235, 255, 0.5); display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; fill: rgba(0, 0, 0, 0.8); color: rgba(0, 0, 0, 0.8); background-color: rgb(245, 235, 255); text-align: center;"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(331.44791412353516, 32)" id="flowchart-A-1456" class="node default"><rect height="48" width="108" y="-24" x="-54" style="" class="basic label-container"></rect><g transform="translate(-24, -9)" style="" class="label"><rect></rect><foreignObject height="18" width="48"><div xmlns="http://www.w3.org/1999/xhtml" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="nodeLabel" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; fill: rgba(0, 0, 0, 0.8); color: rgba(0, 0, 0, 0.8);"><p style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; color: rgb(0, 0, 0); font-size: 12px; font-weight: 400; line-height: 18px;">用户登录</p></span></div></foreignObject></g></g><g transform="translate(331.44791412353516, 130)" id="flowchart-B-1457" class="node default"><rect height="48" width="132" y="-24" x="-66" style="" class="basic label-container"></rect><g transform="translate(-36, -9)" style="" class="label"><rect></rect><foreignObject height="18" width="72"><div xmlns="http://www.w3.org/1999/xhtml" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="nodeLabel" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; fill: rgba(0, 0, 0, 0.8); color: rgba(0, 0, 0, 0.8);"><p style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; color: rgb(0, 0, 0); font-size: 12px; font-weight: 400; line-height: 18px;">浏览图书列表</p></span></div></foreignObject></g></g><g transform="translate(331.44791412353516, 252)" id="flowchart-C-1459" class="node default"><polygon transform="translate(-48,48)" class="label-container" points="48,0 96,-48 48,-96 0,-48"></polygon><g transform="translate(-24, -9)" style="" class="label"><rect></rect><foreignObject height="18" width="48"><div xmlns="http://www.w3.org/1999/xhtml" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="nodeLabel" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; fill: rgba(0, 0, 0, 0.8); color: rgba(0, 0, 0, 0.8);"><p style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; color: rgb(0, 0, 0); font-size: 12px; font-weight: 400; line-height: 18px;">图书操作</p></span></div></foreignObject></g></g><g transform="translate(331.44791412353516, 392)" id="flowchart-D-1461" class="node default"><rect height="48" width="120" y="-24" x="-60" style="" class="basic label-container"></rect><g transform="translate(-30, -9)" style="" class="label"><rect></rect><foreignObject height="18" width="60"><div xmlns="http://www.w3.org/1999/xhtml" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="nodeLabel" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; fill: rgba(0, 0, 0, 0.8); color: rgba(0, 0, 0, 0.8);"><p style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; color: rgb(0, 0, 0); font-size: 12px; font-weight: 400; line-height: 18px;">图书详情页</p></span></div></foreignObject></g></g><g transform="translate(331.44791412353516, 514)" id="flowchart-E-1463" class="node default"><polygon transform="translate(-48,48)" class="label-container" points="48,0 96,-48 48,-96 0,-48"></polygon><g transform="translate(-24, -9)" style="" class="label"><rect></rect><foreignObject height="18" width="48"><div xmlns="http://www.w3.org/1999/xhtml" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="nodeLabel" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; fill: rgba(0, 0, 0, 0.8); color: rgba(0, 0, 0, 0.8);"><p style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; color: rgb(0, 0, 0); font-size: 12px; font-weight: 400; line-height: 18px;">互动操作</p></span></div></foreignObject></g></g><g transform="translate(98.296875, 654)" id="flowchart-F-1465" class="node default"><rect height="48" width="180.59375" y="-24" x="-90.296875" style="" class="basic label-container"></rect><g transform="translate(-60.296875, -9)" style="" class="label"><rect></rect><foreignObject height="18" width="120.59375"><div xmlns="http://www.w3.org/1999/xhtml" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="nodeLabel" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; fill: rgba(0, 0, 0, 0.8); color: rgba(0, 0, 0, 0.8);"><p style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; color: rgb(0, 0, 0); font-size: 12px; font-weight: 400; line-height: 18px;">生成借阅记录+库存减1</p></span></div></foreignObject></g></g><g transform="translate(331.44791412353516, 654)" id="flowchart-G-1467" class="node default"><rect height="48" width="132" y="-24" x="-66" style="" class="basic label-container"></rect><g transform="translate(-36, -9)" style="" class="label"><rect></rect><foreignObject height="18" width="72"><div xmlns="http://www.w3.org/1999/xhtml" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="nodeLabel" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; fill: rgba(0, 0, 0, 0.8); color: rgba(0, 0, 0, 0.8);"><p style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; color: rgb(0, 0, 0); font-size: 12px; font-weight: 400; line-height: 18px;">新增收藏记录</p></span></div></foreignObject></g></g><g transform="translate(528.5989532470703, 654)" id="flowchart-H-1469" class="node default"><rect height="48" width="162.30208587646484" y="-24" x="-81.15104293823242" style="" class="basic label-container"></rect><g transform="translate(-51.15104293823242, -9)" style="" class="label"><rect></rect><foreignObject height="18" width="102.30208587646484"><div xmlns="http://www.w3.org/1999/xhtml" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="nodeLabel" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; fill: rgba(0, 0, 0, 0.8); color: rgba(0, 0, 0, 0.8);"><p style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; color: rgb(0, 0, 0); font-size: 12px; font-weight: 400; line-height: 18px;">新增评论+关联图书</p></span></div></foreignObject></g></g><g transform="translate(98.296875, 752)" id="flowchart-I-1471" class="node default"><rect height="48" width="168" y="-24" x="-84" style="" class="basic label-container"></rect><g transform="translate(-54, -9)" style="" class="label"><rect></rect><foreignObject height="18" width="108"><div xmlns="http://www.w3.org/1999/xhtml" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="nodeLabel" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; fill: rgba(0, 0, 0, 0.8); color: rgba(0, 0, 0, 0.8);"><p style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; color: rgb(0, 0, 0); font-size: 12px; font-weight: 400; line-height: 18px;">借阅管理页查看记录</p></span></div></foreignObject></g></g><g transform="translate(98.296875, 850)" id="flowchart-J-1473" class="node default"><rect height="48" width="156.59375" y="-24" x="-78.296875" style="" class="basic label-container"></rect><g transform="translate(-48.296875, -9)" style="" class="label"><rect></rect><foreignObject height="18" width="96.59375"><div xmlns="http://www.w3.org/1999/xhtml" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="nodeLabel" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; fill: rgba(0, 0, 0, 0.8); color: rgba(0, 0, 0, 0.8);"><p style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; color: rgb(0, 0, 0); font-size: 12px; font-weight: 400; line-height: 18px;">发起归还+库存加1</p></span></div></foreignObject></g></g><g transform="translate(331.44791412353516, 752)" id="flowchart-K-1475" class="node default"><rect height="48" width="198.30209350585938" y="-24" x="-99.15104675292969" style="" class="basic label-container"></rect><g transform="translate(-69.15104675292969, -9)" style="" class="label"><rect></rect><foreignObject height="18" width="138.30209350585938"><div xmlns="http://www.w3.org/1999/xhtml" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="nodeLabel" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; fill: rgba(0, 0, 0, 0.8); color: rgba(0, 0, 0, 0.8);"><p style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); outline: none; border: 0px solid; margin: 0px; padding: 0px; overflow-anchor: auto; color: rgb(0, 0, 0); font-size: 12px; font-weight: 400; line-height: 18px;">收藏列表页查看/取消收藏</p></span></div></foreignObject></g></g></g></g></g></g></svg>



### 3.2 模块间关键依赖

| 依赖方模块  | 被依赖方模块 | 依赖内容                        |
| ----------- | ------------ | ------------------------------- |
| 借阅模块    | 图书模块     | 图书库存状态、图书存在性校验    |
| 互动模块    | 用户模块     | 用户身份校验（user_id）         |
| 互动模块    | 图书模块     | 图书存在性校验（book_id）       |
| AI 助手模块 | 图书模块     | 图书数据（用于推荐 / 问答）     |
| 所有模块    | 认证模块     | Token 校验（未登录→跳转登录页） |

## 四、逆向流程汇总

逆向流程是正向流程的「撤销 / 回滚」操作，核心场景与处理逻辑如下：

| 正向流程 | 逆向流程         | 处理逻辑                                    | 数据一致性保障                     |
| -------- | ---------------- | ------------------------------------------- | ---------------------------------- |
| 图书借阅 | 图书归还         | 借阅记录 status→returned，图书 stock+1      | 若库存更新失败，回滚借阅记录状态   |
| 评论点赞 | 取消点赞         | 删除 CommentLikes 记录，Comments 表 likes-1 | 若 Comments 更新失败，回滚点赞记录 |
| 图书收藏 | 取消收藏         | 删除 Favorites 记录                         | 无关联数据，直接删除               |
| 新增评论 | （暂不支持删除） | -                                           | -                                  |
| 预约图书 | 取消预约         | 预约记录 status→cancelled                   | 无关联数据，直接更新               |

## 五、关键结果集规范

所有接口遵循统一的结果集格式，前端通过`api.js`拦截器自动解析，保障交互一致性：

### 5.1 成功结果集（statusCode=200/201）

```json
{
  "success": true,
  "data": {
    "token": "user-uuid-token",  // 登录成功
    "book_id": "uuid",         // 新增图书成功
    "borrow_id": "uuid"        // 借阅成功
  },
  "message": "操作成功"
}
```

### 5.2 失败结果集（statusCode=400/401/403/500）

```json
{
  "success": false,
  "error": "验证码已过期",  // 业务错误
  "detail": "OTS查询验证码过期时间=1699999999，当前时间=1700000000"  // 调试信息
}
```