## FluxLib泛集库系统整体架构

## 后端技术栈

- **Web框架**: Flask + Blueprint路由管理
- **数据存储**: 阿里云OTS（表格存储）+ Redis缓存
- **文件存储**: 阿里云OSS（对象存储）
- **AI服务**: DeepSeek API
- **邮件服务**: SMTP邮件服务（QQ邮箱）



## 前端技术栈

- **框架**: Vue3 + Element Plus UI
- **状态管理**: Pinia
- **路由**: Vue Router



## 核心数据模型

### 1.用户系统 (Users表)

**存储**: 用户基本信息、权限、个人资料
**上游**: 注册流程、登录验证
**下游**: 所有需要用户身份的操作

```python
# 关键字段: email(主键), user_id, password, role, display_name, avatar_url
```

### 2. 图书系统 (Books表)

**存储**: 图书元数据、库存状态
**上游**: 管理员创建/编辑
**下游**: 借阅、收藏、评论、浏览历史

```python
# 关键字段: book_id(主键), title, author, stock, status, cover
```

### 3. 借阅系统 (BorrowRecords表)

**存储**: 借阅记录、归还状态、时间信息
**上游**: 用户借阅操作
**下游**: 库存更新、逾期计算

```python
# 关键字段: borrow_id(主键), book_id, user_id, status, borrow_date, due_date
```

## 核心业务流程

### 📚 正向流程：完整借阅链路

text

```
用户登录 → 浏览图书 → 查看详情 → 借阅图书 → 库存扣减 → 生成借阅记录
    ↓
到期提醒 → 归还图书 → 库存恢复 → 更新借阅状态 → 记录完成
```



###  详细业务流转

#### 1. 用户认证流程

```
graph LR
A[用户访问] --> B{是否登录}
B -->|否| C[登录/注册]
B -->|是| D[权限校验]
C --> E[发送验证码]
E --> F[验证身份]
F --> G[获取Token]
G --> D
D --> H[访问系统]
```



#### 2. 图书借阅核心流程

```
graph TD
A[用户浏览图书] --> B[选择图书]
B --> C[检查库存]
C -->|有库存| D[创建借阅记录]
C -->|无库存| E[预约借阅]
D --> F[扣减库存]
F --> G[更新图书状态]
G --> H[借阅成功]
E --> I[发送预约确认]
```



#### 3. 数据状态分布

**图书状态机**:

text

```
available → borrowed → available
    ↓
maintenance
```



**借阅记录状态机**:

text

```
borrowed → returned
    ↓
early_return
```



## 各子系统职责与数据流

### 1. 认证系统 (Auth)

**上游**: 无
**下游**: 所有需要身份验证的模块

python

```
# 核心服务: auth_service.py
# 关键功能: 注册、登录、密码重置、权限校验
```



### 2. 图书管理系统 (Book Management)

**上游**: 管理员操作
**下游**: 借阅、收藏、评论

python

```
# 核心服务: book_service.py
# 关键功能: CRUD、封面上传、库存管理
```



### 3. 借阅系统 (Borrow Management)

**上游**: 用户借阅请求、图书库存
**下游**: 库存更新、邮件通知

python

```
# 核心服务: borrow_service.py
# 关键功能: 借阅、归还、批量操作、预约
```



### 4. 用户交互系统 (User Interaction)

**上游**: 用户行为
**下游**: 数据记录、个性化推荐

python

```
# 包含: 收藏、评论、浏览历史、个人资料
```



### 5. AI助手系统 (AI Service)

**上游**: 用户查询、图书数据
**下游**: 智能回复、推荐

python

```
# 核心服务: ai_service.py
# 关键功能: 基于DeepSeek的智能问答
```



## 📈 数据流转示例

### 用户借阅一本书的完整数据流：

1. **前端** → `borrowBook(bookId)` → API层
2. **API路由** → `borrow_service.borrow_book()` → 服务层
3. **服务层**:
   - 校验用户权限
   - 检查图书库存
   - 创建借阅记录
   - 更新图书库存
4. **数据层**:
   - `Borrow.create_borrow()` → BorrowRecords表
   - `Book.update_stock()` → Books表
5. **返回结果** → 前端状态更新

### 库存扣减的逆向流程：

python

```
# 正向: 借阅时 stock -1
# 逆向: 归还时 stock +1
# 异常处理: 库存不足时阻止借阅
```



## 🗂️ 结果集与数据聚合

### 主要查询结果集：

1. **图书列表**: 分页+分类+搜索
2. **借阅历史**: 用户维度+时间排序
3. **收藏列表**: 用户个性化数据
4. **评论树**: 父子结构+点赞排序
5. **统计报表**: 借阅趋势+分类分布

### 缓存策略：

python

```
# Redis缓存键设计:
- user:{user_id} → 用户信息
- token:{token} → 用户ID映射  
- 借阅记录、收藏状态等热点数据
```



## 🔄 异常处理与逆向流程

### 主要异常场景：

1. **库存不足**: 转为预约流程
2. **权限不足**: 管理员操作拦截
3. **验证码失效**: 重新发送流程
4. **网络超时**: 重试机制
5. **数据一致性**: 事务回滚

### 逆向业务流程：

- **取消借阅**: 删除借阅记录 + 恢复库存
- **取消收藏**: 移除收藏记录
- **删除评论**: 级联删除回复
- **图书下架**: 检查借阅状态 + 状态变更