# FluxLib 泛集库业务流程文档

## 一、整体架构概述

FluxLib 泛集库采用**前后端分离架构**，基于「前端交互层 - 后端服务层 - 数据存储层」三层架构设计，各层职责与技术栈明确，链路流转清晰。

### 1.1 架构分层与核心组件

| 层级       | 技术栈                                        | 核心职责                             | 关键组件示例                                                 |
| ---------- | --------------------------------------------- | ------------------------------------ | ------------------------------------------------------------ |
| 前端交互层 | Vue 3 + Element Plus + Pinia                  | 用户交互、状态管理、请求封装         | 视图（LoginView/BooksView）、Store（user.js/book.js）、API 封装（api.js） |
| 后端服务层 | Flask + 分层架构（路由 - 服务 - 模型 - 仓储） | 接收请求、业务逻辑处理、数据访问调度 | 路由（auth_routes.py）、服务（auth_service.py）、模型（user.py）、仓储（user_repository.py） |
| 数据存储层 | 阿里云 OTS（表格存储）+ Redis + OSS           | 结构化数据存储、缓存、文件存储       | OTS 表（USERS_TABLE/Books）、Redis（Token 缓存）、OSS（图书封面） |

### 1.2 核心业务模块清单

系统围绕「图书管理」核心，衍生出 6 大业务模块，各模块独立且联动：

1. 用户认证模块（登录 / 注册 / 密码重置）
2. 图书管理模块（图书 CRUD / 库存管理）
3. 借阅预约模块（借阅 / 归还 / 预约）
4. 互动模块（评论 / 点赞 / 收藏 / 浏览历史）
5. AI 助手模块（智能问答 / 图书推荐）
6. 系统管理模块（管理员仪表盘 / 数据分析）

## 二、核心业务模块详细流程

### 2.1 用户认证模块

#### 2.1.1 模块定位与数据存储

- **核心功能**：用户身份校验、权限控制（普通用户 / 管理员）、账号安全（验证码 / 密码重置）

- 涉及系统：

  - 前端：`LoginView.vue`（登录 / 注册）、`ForgotPassword.vue`（密码重置）、`user.js`（状态管理）、`api.js`（认证请求封装）
  - 后端：`user.py`（用户模型）、`user_repository.py`（用户数据仓储）、`auth_service.py`（认证业务逻辑）、`auth_routes.py`（认证路由）
  
- 数据存储：

  - `USERS_TABLE`（OTS）：存储用户核心信息（user_id/email/password/role/avatar_url 等）
  - `VERIFICATION_CODES_TABLE`（OTS）：存储验证码（email/code/type/expire_time）
  - Redis：缓存 Token（token→user_id 映射）、用户信息（减少 OTS 查询）

#### 2.1.2 上下游链路

- **上游**：用户输入（邮箱 / 密码 / 验证码）
- **下游**：所有需要身份校验的模块（图书借阅、收藏、评论等，均需通过 Token 获取用户 ID）

#### 2.1.3 正向流程（以「登录」为例）

![image](https://github.com/Janhone888/FluxLib1/blob/main/picture/业务流程/登陆.png)

#### 2.1.4 逆向流程（以「密码重置失败」为例）

![image](https://github.com/Janhone888/FluxLib1/blob/main/picture/业务流程/密码重置失败.png)

#### 2.1.5 关键状态与结果集

| 业务场景 | 核心状态                           | 成功结果集（示例）                                  | 失败结果集（示例）         |
| -------- | ---------------------------------- | --------------------------------------------------- | -------------------------- |
| 登录     | 未登录→已登录（普通用户 / 管理员） | `{"token":"xxx","user_id":"uuid","is_admin":false}` | `{"error":"密码错误"}`     |
| 注册     | 未注册→已注册（待验证→已验证）     | `{"user_id":"uuid","message":"注册成功"}`           | `{"error":"邮箱已注册"}`   |
| 密码重置 | 密码过期→密码更新                  | `{"message":"密码重置成功"}`                        | `{"error":"验证码已过期"}` |

### 2.2 图书管理模块

#### 2.2.1 模块定位与数据存储

- **核心功能**：图书信息管理（新增 / 编辑 / 删除 / 查询）、库存状态维护（借阅减库存 / 归还加库存）
- 涉及系统：
  - 前端：`BooksView`（图书列表）、`AddBook/EditBook`（图书 CRUD）、`BookDetail`（图书详情）、`book.js`（图书状态管理）
  - 后端：`book.py`（图书模型）、`book_repository.py`（图书仓储）、`book_service.py`（图书业务）、`book_routes.py`（图书路由）
- 数据存储：
  - `OTS_TABLE_NAME`（默认`Books`，OTS 表）：存储图书核心信息（book_id/title/author/stock/status 等）
  - OSS：存储图书封面图片（通过预签名 URL 上传）

#### 2.2.2 上下游链路

- **上游**：
  - 管理员操作（新增 / 编辑 / 删除图书）
  - 用户行为（浏览图书→触发浏览历史记录，借阅→触发库存更新）
- **下游**：借阅模块（库存不足时无法借阅）、互动模块（图书详情页关联评论 / 收藏）

#### 2.2.3 正向流程（以「管理员新增图书」为例）

![image](https://github.com/Janhone888/FluxLib1/blob/main/picture/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B/%E7%AE%A1%E7%90%86%E5%91%98%E6%96%B0%E5%A2%9E%E5%9B%BE%E4%B9%A6.png)

#### 2.2.4 逆向流程（以「图书删除」为例）

![image](https://github.com/Janhone888/FluxLib1/blob/main/picture/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B/%E5%9B%BE%E4%B9%A6%E5%88%A0%E9%99%A4.png)

#### 2.2.5 关键状态与结果集

| 业务场景 | 核心状态                      | 成功结果集（示例）                            | 失败结果集（示例）              |
| -------- | ----------------------------- | --------------------------------------------- | ------------------------------- |
| 新增图书 | 无→已存在（status=available） | `{"book_id":"uuid","message":"图书创建成功"}` | `{"error":"缺少书名（title）"}` |
| 图书查询 | -                             | `{"items":[...],"total":128,"page":1}`        | `{"error":"图书不存在"}`        |
| 库存更新 | 库存 N→N±1（status 同步更新） | `{"success":true,"message":"库存更新成功"}`   | `{"error":"库存不足"}`          |

### 2.3 借阅预约模块

#### 2.3.1 模块定位与数据存储

- **核心功能**：图书借阅、按期 / 提前归还、图书预约（库存不足时）
- 涉及系统：
  - 前端：`BorrowManage.vue`（借阅管理）、`BookDetail.vue`（借阅 / 归还按钮）、`book.js`（库存状态同步）
  - 后端：`borrow.py`（借阅模型）、`borrow_repository.py`（借阅仓储）、`borrow_service.py`（借阅业务）、`borrow_routes.py`（借阅路由）
- 数据存储：
  - `BORROW_RECORDS_TABLE`（OTS）：存储借阅记录（borrow_id/book_id/user_id/borrow_date/due_date/status）
  - `RESERVATIONS_TABLE`（OTS）：存储预约记录（reservation_id/book_id/reserve_date/time_slot）

#### 2.3.2 上下游链路

- **上游**：用户操作（图书详情页点击「借阅」/「预约」）、图书模块（库存状态校验）
- **下游**：图书模块（借阅减库存 / 归还加库存）、用户模块（借阅记录关联用户）

#### 2.3.3 核心正向流程（「借阅→归还」全链路）

![image](https://github.com/Janhone888/FluxLib1/blob/main/picture/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B/%E3%80%8C%E5%80%9F%E9%98%85%E2%86%92%E5%BD%92%E8%BF%98%E3%80%8D%E5%85%A8%E9%93%BE%E8%B7%AF.png)

#### 2.3.4 关键状态流转

借阅记录与图书库存存在强关联，状态同步流转：

1. **借阅状态流转**：`未借阅` → 发起借阅 → `借阅中（borrowed）` → 发起归还 → `已归还（returned）`
2. **图书库存流转**：`available（stock=N）` → 借阅 → `available（stock=N-1）`/`borrowed（stock=0）` → 归还 → `available（stock=N）`
3. **预约状态流转**：`无预约` → 发起预约 → `已预约（reserved）` → 预约完成 → `已完成（fulfilled）`/`已取消（cancelled）`

### 2.4 互动模块（评论 / 点赞 / 收藏 / 浏览历史）

#### 2.4.1 模块定位与数据存储

- **核心功能**：用户与图书的互动操作，提升用户粘性
- **涉及系统**：
  - 前端：`BookDetail`（评论区 / 收藏按钮）、`Favorites.vue`（收藏列表）、`History.vue`（浏览历史）
  - 后端：`comment.py`/`favorite.py`/`view_history.py`（模型）、对应服务 / 仓储 / 路由
- 数据存储：
  - `COMMENTS_TABLE`（OTS）：评论主表（comment_id/book_id/content/likes）
  - `COMMENT_LIKES_TABLE`（OTS）：评论点赞表（复合主键：comment_id+user_id）
  - `FAVORITES_TABLE`（OTS）：收藏表（favorite_id/user_id/book_id）
  - `VIEW_HISTORY_TABLE`（OTS）：浏览历史表（history_id/user_id/book_id/view_time）

#### 2.4.2 核心流程（以「评论点赞」为例）

![image](https://github.com/Janhone888/FluxLib1/blob/main/picture/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B/%E8%AF%84%E8%AE%BA%E7%82%B9%E8%B5%9E.png)

## 三、业务总链路与关键依赖

### 3.1 核心业务总链路（用户视角）

![image](https://github.com/Janhone888/FluxLib1/blob/main/picture/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B/%E6%A0%B8%E5%BF%83%E4%B8%9A%E5%8A%A1%E6%80%BB%E9%93%BE%E8%B7%AF%EF%BC%88%E7%94%A8%E6%88%B7%E8%A7%86%E8%A7%92%EF%BC%89.png)

### 3.2 模块间关键依赖

| 依赖方模块  | 被依赖方模块 | 依赖内容                        |
| ----------- | ------------ | ------------------------------- |
| 借阅模块    | 图书模块     | 图书库存状态、图书存在性校验    |
| 互动模块    | 用户模块     | 用户身份校验（user_id）         |
| 互动模块    | 图书模块     | 图书存在性校验（book_id）       |
| AI 助手模块 | 图书模块     | 图书数据（用于推荐 / 问答）     |
| 所有模块    | 认证模块     | Token 校验（未登录→跳转登录页） |

## 四、逆向流程汇总

逆向流程是正向流程的「撤销 / 回滚」操作，核心场景与处理逻辑如下：

| 正向流程 | 逆向流程         | 处理逻辑                                    | 数据一致性保障                     |
| -------- | ---------------- | ------------------------------------------- | ---------------------------------- |
| 图书借阅 | 图书归还         | 借阅记录 status→returned，图书 stock+1      | 若库存更新失败，回滚借阅记录状态   |
| 评论点赞 | 取消点赞         | 删除 CommentLikes 记录，Comments 表 likes-1 | 若 Comments 更新失败，回滚点赞记录 |
| 图书收藏 | 取消收藏         | 删除 Favorites 记录                         | 无关联数据，直接删除               |
| 新增评论 | （暂不支持删除） | -                                           | -                                  |
| 预约图书 | 取消预约         | 预约记录 status→cancelled                   | 无关联数据，直接更新               |

## 五、关键结果集规范

所有接口遵循统一的结果集格式，前端通过`api.js`拦截器自动解析，保障交互一致性：

### 5.1 成功结果集（statusCode=200/201）

```json
{
  "success": true,
  "data": {
    "token": "user-uuid-token",  // 登录成功
    "book_id": "uuid",         // 新增图书成功
    "borrow_id": "uuid"        // 借阅成功
  },
  "message": "操作成功"
}
```

### 5.2 失败结果集（statusCode=400/401/403/500）

```json
{
  "success": false,
  "error": "验证码已过期",  // 业务错误
  "detail": "OTS查询验证码过期时间=1699999999，当前时间=1700000000"  // 调试信息
}
```